<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Livestock Health Assistant</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .container {
            max-width: 900px;
        }
        .message {
            padding: 1rem;
            border-radius: 0.5rem;
            margin-bottom: 0.75rem;
            position: relative;
        }
        .message-bot {
            background-color: #e0f2fe;
            border-top-left-radius: 0;
            margin-right: 20%;
        }
        .message-user {
            background-color: #d1fae5;
            border-top-right-radius: 0;
            margin-left: 20%;
        }
        .loading-dots {
            display: inline-block;
            width: 1rem;
            height: 1rem;
            border-radius: 50%;
            background-color: #60a5fa;
            animation: bounce 1.2s ease-in-out infinite;
        }
        .loading-dots:nth-child(2) {
            animation-delay: 0.2s;
        }
        .loading-dots:nth-child(3) {
            animation-delay: 0.4s;
        }
        @keyframes bounce {
            0%, 100% {
                transform: translateY(0);
            }
            50% {
                transform: translateY(-0.5rem);
            }
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen p-4">

    <div class="container bg-white shadow-xl rounded-2xl p-6 md:p-8 flex flex-col h-[90vh]">
        <!-- Header -->
        <div class="mb-6 text-center">
            <h1 class="text-3xl font-bold text-blue-800">AI Livestock Health Assistant</h1>
            <p class="text-sm text-gray-500 mt-2">Get quick insights on pig and poultry health conditions.</p>
        </div>

        <!-- Chat area -->
        <div id="chat-box" class="flex-1 overflow-y-auto p-4 border border-gray-200 rounded-xl mb-6 bg-gray-50">
            <!-- Messages will be appended here -->
            <div class="message message-bot">
                <p>Hello! I am an AI bot here to assist with potential health conditions in your livestock. Please provide the following information to get started:</p>
                <ul class="list-disc list-inside mt-2">
                    <li>Animal Type (pig or poultry)</li>
                    <li>Animal ID</li>
                    <li>Symptoms</li>
                </ul>
            </div>
        </div>

        <!-- Input form -->
        <div class="flex flex-col md:flex-row gap-4">
            <div class="flex flex-col w-full md:w-1/3">
                <label for="animalType" class="text-sm font-medium text-gray-700 mb-1">Animal Type</label>
                <select id="animalType" class="p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <option value="pig">Pig</option>
                    <option value="poultry">Poultry</option>
                </select>
            </div>
            <div class="flex flex-col w-full md:w-1/3">
                <label for="animalId" class="text-sm font-medium text-gray-700 mb-1">Animal ID</label>
                <input type="text" id="animalId" placeholder="e.g., P-123" class="p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
            </div>
            <div class="flex-1 flex flex-col">
                <label for="symptoms" class="text-sm font-medium text-gray-700 mb-1">Symptoms</label>
                <textarea id="symptoms" placeholder="e.g., Lethargy, reduced appetite, coughing" rows="2" class="p-3 border border-gray-300 rounded-lg resize-none focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
            </div>
        </div>
        <div class="flex flex-col md:flex-row gap-4 mt-4 w-full md:w-auto md:self-end">
            <button id="backBtn" class="w-full md:w-auto px-6 py-3 bg-gray-400 text-white font-semibold rounded-lg shadow-md hover:bg-gray-500 transition-colors focus:outline-none focus:ring-2 focus:ring-gray-400 focus:ring-offset-2">
                Back to Home
            </button>
            <button id="submitBtn" class="w-full md:w-auto px-6 py-3 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700 transition-colors focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
                Diagnose
            </button>
        </div>
    </div>

    <script>
        const animalTypeSelect = document.getElementById('animalType');
        const animalIdInput = document.getElementById('animalId');
        const symptomsTextarea = document.getElementById('symptoms');
        const submitBtn = document.getElementById('submitBtn');
        const backBtn = document.getElementById('backBtn');
        const chatBox = document.getElementById('chat-box');

        const apiKey = ""; 
        const apiUrl = "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=" + apiKey;

        const systemPrompt = `You are a specialized AI assistant for livestock health, focusing on pigs and poultry. Your task is to provide a potential diagnosis and a general recommendation based on the symptoms provided by a user.
        
        When a user provides an animal type (pig or poultry), animal ID, and a list of symptoms, you will:
        1.  Analyze the symptoms to identify a probable disease or condition.
        2.  Explain the disease in simple terms.
        3.  Suggest a general course of action.
        
        Your response must be structured as follows:
        **Probable Diagnosis:** [Disease Name]
        
        **Description:** [A brief, simple explanation of the disease.]
        
        **Recommendations:**
        * [Recommendation 1]
        * [Recommendation 2]
        * [Recommendation 3]
        
        Example for a Pig:
        **Probable Diagnosis:** Porcine Circovirus Disease (PCVAD)
        
        **Description:** PCVAD is a viral disease that can cause wasting, pale skin, and respiratory issues in pigs.
        
        **Recommendations:**
        * Consult with a veterinarian for a definitive diagnosis and treatment plan.
        * Isolate the affected animal to prevent the spread of the disease.
        * Ensure the animal has a clean, dry, and well-ventilated living area.
        
        Example for Poultry:
        **Probable Diagnosis:** Avian Influenza (Bird Flu)
        
        **Description:** Avian Influenza is a highly contagious viral disease that can cause respiratory distress, reduced egg production, and sudden death.
        
        **Recommendations:**
        * Immediately contact a veterinarian or a government animal health authority.
        * Do not move any animals, equipment, or feed from the farm.
        * Implement strict biosecurity measures, including cleaning and disinfecting all equipment and limiting access to the farm.
        
        Always start your response with "**Probable Diagnosis:**" and ensure all information is based on the provided symptoms. Do not invent information or provide medical advice beyond general recommendations. Advise the user to consult with a professional veterinarian.`;

        // Function to create a chat bubble
        function createChatBubble(message, sender) {
            const messageElement = document.createElement('div');
            messageElement.classList.add('message');
            if (sender === 'user') {
                messageElement.classList.add('message-user');
            } else {
                messageElement.classList.add('message-bot');
            }
            messageElement.innerHTML = `<p>${message}</p>`;
            chatBox.appendChild(messageElement);
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        // Function to add a loading indicator
        function addLoadingIndicator() {
            const loadingContainer = document.createElement('div');
            loadingContainer.id = 'loading-indicator';
            loadingContainer.classList.add('message', 'message-bot', 'flex', 'items-center', 'gap-2');
            loadingContainer.innerHTML = `
                <span class="loading-dots"></span>
                <span class="loading-dots"></span>
                <span class="loading-dots"></span>
            `;
            chatBox.appendChild(loadingContainer);
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        // Function to remove the loading indicator
        function removeLoadingIndicator() {
            const loadingIndicator = document.getElementById('loading-indicator');
            if (loadingIndicator) {
                loadingIndicator.remove();
            }
        }

        submitBtn.addEventListener('click', async () => {
            const animalType = animalTypeSelect.value;
            const animalId = animalIdInput.value.trim();
            const symptoms = symptomsTextarea.value.trim();

            if (!animalId || !symptoms) {
                createChatBubble("Please fill in both Animal ID and Symptoms.", 'bot');
                return;
            }

            const userMessage = `**Animal Type:** ${animalType}\n**Animal ID:** ${animalId}\n**Symptoms:** ${symptoms}`;
            createChatBubble(userMessage.replace(/\n/g, '<br>'), 'user');

            // Construct the data object to save
            const diagnosisData = {
                animalType: animalType,
                animalId: animalId,
                symptoms: symptoms,
                timestamp: new Date().toISOString()
            };

            // Save the data to the MySQL database via PHP
            try {
                const response = await fetch('save_data.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(diagnosisData)
                });
                const result = await response.json();
                if (result.success) {
                    console.log("Data successfully saved to MySQL database!");
                } else {
                    console.error("Error saving data:", result.message);
                    createChatBubble("Sorry, I could not save your data at this time.", 'bot');
                }
            } catch (e) {
                console.error("Error connecting to PHP backend:", e);
                createChatBubble("Sorry, a network error occurred while trying to save your data.", 'bot');
            }
            
            // Clear input fields
            animalIdInput.value = '';
            symptomsTextarea.value = '';

            addLoadingIndicator();

            const payload = {
                contents: [{
                    parts: [{
                        text: `Animal Type: ${animalType}, Animal ID: ${animalId}, Symptoms: ${symptoms}`
                    }]
                }],
                systemInstruction: {
                    parts: [{ text: systemPrompt }]
                }
            };
            
            let retryCount = 0;
            const maxRetries = 3;
            const delay = 1000;

            const fetchData = async () => {
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    const result = await response.json();
                    const aiResponse = result.candidates?.[0]?.content?.parts?.[0]?.text;

                    if (aiResponse) {
                        removeLoadingIndicator();
                        createChatBubble(aiResponse.replace(/\n/g, '<br>'), 'bot');
                    } else {
                        throw new Error('No AI response received.');
                    }
                } catch (error) {
                    console.error('API call failed:', error);
                    if (retryCount < maxRetries) {
                        retryCount++;
                        setTimeout(fetchData, delay * Math.pow(2, retryCount));
                    } else {
                        removeLoadingIndicator();
                        createChatBubble("Sorry, I could not process your request. Please try again later.", 'bot');
                    }
                }
            };

            fetchData();
        });

        // Event listener for the new "Back" button
        backBtn.addEventListener('click', () => {
            window.location.href = 'index.php';
        });
    </script>
</body>
</html>
