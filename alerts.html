<?php
session_start();
require_once __DIR__ . '/../config/config.php';

// Protect page: only admin can access
if (!isset($_SESSION['worker_id']) || $_SESSION['role'] !== 'admin') {
    header("Location: ../login.php");
    exit;
}

$success = '';
$error = '';

// Handle Add Alert
if ($_SERVER['REQUEST_METHOD'] === 'POST' && $_POST['action'] === 'add') {
    $message = trim($_POST['message']);
    $priority = $_POST['priority'];
    $date = $_POST['date'];
    $assigned_to = (int) $_POST['assigned_to'];

    $stmt = $conn->prepare("INSERT INTO alerts (message, priority, date, assigned_to, status) VALUES (?,?,?,?, 'pending')");
    $stmt->bind_param("sssi", $message, $priority, $date, $assigned_to);

    if ($stmt->execute()) {
        $success = "Alert sent successfully.";
    } else {
        $error = "Error: " . $conn->error;
    }
    $stmt->close();
}

// Handle Delete
if (isset($_GET['delete'])) {
    $id = (int) $_GET['delete'];
    $conn->query("DELETE FROM alerts WHERE id=$id");
    $success = "Alert deleted.";
}

// Fetch workers list
$workers = $conn->query("SELECT id, username FROM workers ORDER BY username");

// Fetch alerts list
$alerts = $conn->query("
    SELECT a.*, w.username 
    FROM alerts a 
    LEFT JOIN workers w ON a.assigned_to = w.id
    ORDER BY a.date DESC, a.created_at DESC
");


require '../phpmailer/src/Exception.php';
require '../phpmailer/src/PHPMailer.php';
require '../phpmailer/src/SMTP.php';

use PHPMailer\PHPMailer\PHPMailer;
use PHPMailer\PHPMailer\Exception;

$mail = new PHPMailer(true);

if ($_SERVER['REQUEST_METHOD'] == 'POST') {
    $staff_id = $_POST['assigned_to'];
    $task     = trim($_POST['message']);
    $due_date = $_POST['date'];

    // 1. Fetch staff details from DB
    $staffQuery = "SELECT username, email FROM workers WHERE id = '$staff_id'";
    $staffRes   = mysqli_query($conn, $staffQuery);

    if ($staffRes && mysqli_num_rows($staffRes) > 0) {
        $staff   = mysqli_fetch_assoc($staffRes);
        $toEmail = $staff['email'];
        $toName  = $staff['username'];

        // 3. Send Email with PHPMailer
        $mail = new PHPMailer(true);
        try {
            $mail->isSMTP();
            $mail->Host       = 'smtp.gmail.com';
            $mail->SMTPAuth   = true;
            $mail->Username   = 'farmguard660@gmail.com';   // your Gmail
            $mail->Password   = 'hrai vaex cfal pjrw';      // Gmail App Password
            $mail->SMTPSecure = 'tls';
            $mail->Port       = 587;

            $mail->setFrom('farmguard660@gmail.com', 'FarmGuard');
            $mail->addAddress($toEmail, $toName);

            $mail->isHTML(true);
            $mail->Subject = "New Task Assigned - FarmGuard";
            $mail->Body    = "
                <h2>Hello $toName,</h2>
                <p>You have been assigned a new task in FarmGuard:</p>
                <p><b>Task:</b> $task</p>
                <p><b>Due Date:</b> $due_date</p>
                <p>Please ensure it is completed on time.</p>
                <br><p>Regards,<br>FarmGuard Admin</p>
            ";

            $mail->send();
            $msg = "✅ Task saved and email sent to $toName ($toEmail)";
        } catch (Exception $e) {
            $msg = "❌ Task saved, but email not sent. Error: {$mail->ErrorInfo}";
        }
    } else {
        $msg = "❌ Staff not found!";
    }
}

?>
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Manage Alerts - FarmGuard Admin</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { font-family:Arial, sans-serif; background:#f9fafb; margin:0; }
    header { background:#2563eb; color:white; padding:1rem; display:flex; justify-content:space-between; }
    header a { color:white; text-decoration:none; background:#1e3a8a; padding:0.5rem 1rem; border-radius:5px; }
    .container { padding:2rem; }
    h1 { color:#2563eb; }

    table { width:100%; border-collapse:collapse; background:white; margin-top:1rem; }
    th, td { padding:0.8rem; border-bottom:1px solid #ddd; text-align:left; }
    th { background:#f1f5f9; }

    form { background:white; padding:1rem; border-radius:6px; box-shadow:0 2px 6px rgba(0,0,0,0.1); margin-bottom:1rem; }
    label { display:block; margin-top:0.5rem; }
    input, select, textarea { width:100%; padding:0.6rem; margin-top:0.2rem; border:1px solid #ccc; border-radius:5px; }
    button { margin-top:1rem; background:#2563eb; color:white; border:none; padding:0.6rem 1rem; border-radius:5px; cursor:pointer; }
    .btn-danger { background:#dc2626; padding:0.4rem 0.8rem; border-radius:5px; color:white; text-decoration:none; }
    .btn-danger:hover { background:#b91c1c; }
  </style>
</head>
<body>
  <header>
    <div>FarmGuard Admin</div>
    <a href="index.php">Dashboard</a>
  </header>
  <div class="container">
    <h1>Manage Alerts</h1>

    <?php if ($success): ?><p style="color:green;"><?= $success ?></p><?php endif; ?>
    <?php if ($error): ?><p style="color:red;"><?= $error ?></p><?php endif; ?>

    <!-- Create Alert Form -->
    <form method="post">
      <input type="hidden" name="action" value="add">
      <label>Message</label>
      <textarea name="message" required></textarea>

      <label>Priority</label>
      <select name="priority" required>
        <option value="high">High</option>
        <option value="medium">Medium</option>
        <option value="low">Low</option>
      </select>

      <label>Date</label>
      <input type="date" name="date" required>

      <label>Assign To Worker</label>
      <select name="assigned_to" required>
        <option value="">-- Select Worker --</option>
        <?php while ($w = $workers->fetch_assoc()): ?>
          <option value="<?= $w['id'] ?>"><?= htmlspecialchars($w['username']) ?></option>
        <?php endwhile; ?>
      </select>

      <button type="submit">Send Alert</button>
    </form>

    <!-- Alerts List -->
    <table>
      <thead>
        <tr>
          <th>ID</th>
          <th>Message</th>
          <th>Priority</th>
          <th>Date</th>
          <th>Assigned To</th>
          <th>Status</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        <?php while ($a = $alerts->fetch_assoc()): ?>
          <tr>
            <td><?= $a['id'] ?></td>
            <td><?= htmlspecialchars($a['message']) ?></td>
            <td><?= ucfirst($a['priority']) ?></td>
            <td><?= $a['date'] ?></td>
            <td><?= htmlspecialchars($a['username'] ?? 'Unassigned') ?></td>
            <td><?= ucfirst($a['status']) ?></td>
            <td>
              <a class="btn-danger" href="?delete=<?= $a['id'] ?>" onclick="return confirm('Delete this alert?')">Delete</a>
            </td>
          </tr>
        <?php endwhile; ?>
      </tbody>
    </table>
  </div>
</body>
</html>
